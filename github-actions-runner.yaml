#
#  Author: Hari Sekhon
#  Date: 2021-11-05 04:09:15 +0000 (Fri, 05 Nov 2021)
#
#  vim:ts=2:sts=2:sw=2:et
#
#  https://github.com/harisekhon/Kubernetes-configs
#
#  License: see accompanying Hari Sekhon LICENSE file
#
#  If you're using my code you're welcome to connect with me on LinkedIn
#  and optionally send me feedback to help improve or steer this or other code I publish
#
#  https://www.linkedin.com/in/HariSekhon
#

# ============================================================================ #
#                   G i t H u b   A c t i o n s   R u n n e r
# ============================================================================ #

# You can find the secret agent token on this page when you are logged in:
#
#   https://github.com/<USER>/<REPO>/settings/actions/runners/new?arch=x64&os=linux
#
#   https://github.com/organizations/<ORG>/settings/actions/runners/new?arch=x64&os=linux
#
# 2 agents can share the same token on this page and will be registered successfully

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: github-actions-runner
  namespace: github-actions
  labels:
    app: github-actions-runner
  annotations:
    cluster-autoscaler.kubernetes.io/safe-to-evict: "false"
spec:
  paused: False
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: github-actions-runner
  template:
    metadata:
      labels:
        app: github-actions-runner
    spec:
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
              - key: cloud.google.com/gke-preemptible
                operator: DoesNotExist
              - key: eks.amazonaws.com/capacityType
                operator: NotIn
                values:
                - SPOT
              - key: kubernetes.azure.com/scalesetpriority
                operator: NotIn
                values:
                - spot
      containers:
      - name: github-actions-runner
        #image: harisekhon/github-actions-runner:2.284
        image: harisekhon/github-actions-runner:latest
        #imagePullPolicy: Always
        args:
        - --url
        - https://github.com/<REPO_OR_ORG>  # XXX: replace
        - --token
        - <TOKEN>  # XXX: replace
        - --unattended
        - --ephemeral  # take 1 job and exit. Avoids job interrupts from scaling down
        resources:
          limits:
            cpu: 1
            memory: 4Gi
          requests:
            cpu: 200m
            memory: 256Mi
